<script type="module">
    // Existing imports and firebase initialization...

    async function calculate() {
        let name = document.getElementById("name").value.trim();
        if (!name) {
            alert("Enter your name!");
            return;
        }

        let totalMarks = 0, maxMarks = 0;
        let subjectMarks = {
            Science: 0,
            Maths: 0,
            English: 0,
            SocialScience: 0,
            SecondLanguage: 0,
            Computers: 0
        };

        // Get marks and calculate totals
        for (let i = 0; i < 10; i++) {
            let input = document.getElementById(`mark${i}`);
            let value = parseInt(input.value);
            if (isNaN(value) || value < 0 || value > input.max) {
                alert("Invalid marks entered!");
                return;
            }

            if (i < 3) subjectMarks.Science += value; // Physics, Chemistry, Biology
            if (i === 2) subjectMarks.Maths = value; // Maths
            if (i < 6 && i > 3) subjectMarks.SocialScience += value; // History, Geography
            if (i === 6 || i === 7) subjectMarks.English += value; // English-1, English-2
            if (i === 8) subjectMarks.SecondLanguage = value; // Second Language
            if (i === 9) subjectMarks.Computers = value; // Computers

            totalMarks += value;
            maxMarks += parseInt(input.max);
        }

        // Calculate category averages
        let averages = {
            Science: (subjectMarks.Science / 3).toFixed(2),
            Maths: subjectMarks.Maths.toFixed(2),
            English: (subjectMarks.English / 2).toFixed(2),
            SocialScience: (subjectMarks.SocialScience / 2).toFixed(2),
            SecondLanguage: subjectMarks.SecondLanguage.toFixed(2),
            Computers: subjectMarks.Computers.toFixed(2)
        };

        let percentage = ((totalMarks / maxMarks) * 100).toFixed(2);

        // Display Result
        let resultsDiv = document.getElementById("results");
        resultsDiv.innerHTML = `<h3>${name}'s Result</h3>
                                <p>Percentage: ${percentage}%</p>
                                <p>Science Average: ${averages.Science}</p>
                                <p>Maths: ${averages.Maths}</p>
                                <p>English Average: ${averages.English}</p>
                                <p>Social Science Average: ${averages.SocialScience}</p>
                                <p>Second Language: ${averages.SecondLanguage}</p>
                                <p>Computers: ${averages.Computers}</p>`;
        resultsDiv.style.display = "block";

        // Store only final percentage in Firestore
        try {
            await setDoc(doc(collection(db, "leaderboard"), name), {
                name: name,
                totalPercentage: percentage
            });
        } catch (error) {
            console.error("Error saving to leaderboard: ", error);
        }
    }

    // Other existing functions and window.onload...
</script>
